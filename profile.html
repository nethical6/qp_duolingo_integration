<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duolingo Profile Card</title>
    <style>
        :root {
        --color-primary: #00ff9f;
        --color-on-primary: #000000;
        --color-secondary: #00bfff;
        --color-on-secondary: #000000;
        --color-tertiary: #8a2be2;
        --color-on-tertiary: #ffffff;
        --color-background: #0a0a0a;
        --color-on-background: #00ff9f;
        --color-surface: #111111;
        --color-on-surface: #b0ffda;
        --color-error: #ff0040;
        --color-on-error: #000000;
      }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .profile-card {
            background: var(--color-surface);
            border-color: var(--color-primary);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 320px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .username {
            font-size: 22px;
            font-weight: bold;
            color: var(--color-on-surface);
            margin-bottom: 6px;
        }
        
        .join-date {
            font-size: 13px;
            color: var(--color-on-surface);
            margin-bottom: 10px;
        }

        .last-updated {
            font-size: 12px;
            color: var(--color-on-surface);
            font-style: italic;
            margin-bottom: 10px;
        }

        .streak-status {
            font-size: 15px;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--color-on-surface);
            }


        .streak-status.warning {
            background: #fff4e5;
            color: var(--color-error);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #f8fdf4;
            padding: 14px;
            border-radius: 12px;
            color: var(--color-on-primary);
            background-color: var(--color-primary);
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: var(--color-on-primary);
            display: block;
        }
        
        .stat-label {
            font-size: 11px;
            color: #777;
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .languages-section {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .languages-title {
            font-size: 15px;
            font-weight: bold;
            color: var(--color-on-surface);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .languages-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .language-badge {
            background: var(--color-primary);
            color: var(--color-on-primary);
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .language-flag {
            font-size: 14px;
        }
        
        .streak-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .streak-highlight::before {
            content: 'ðŸ”¥';
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 18px;
        }
        
        .quest-button {
            width: 100%;
            background: var(--color-primary);
            color: var(var(--color-on-primary));
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .open-duolingo {
            width: 100%;
            background: var(--color-primary);
            color: var(var(--color-on-primary));
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quest-button:hover {
            transform: translateY(-1px);
        }
        
        .quest-button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .theme-transition {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="profile-card">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
        <div class="username">DuoMaster2024</div>
        <div class="join-date">Joined September 2023</div>
        <div class="last-updated"></div>
         <div class="streak-status"></div>
        
        <div class="stats-grid">
            <div class="stat-item streak-highlight">
                <span class="stat-number">127</span>
                <span class="stat-label">Day Streak</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">8,432</span>
                <span class="stat-label">Total XP</span>
            </div>
        </div>

        
        <div class="languages-section">
            <div class="languages-title">Learning</div>
            <div class="languages-list">
                <div class="language-badge">
                    <span class="language-flag">ðŸ‡ªðŸ‡¸</span>
                    Spanish
                </div>
                <div class="language-badge">
                    <span class="language-flag">ðŸ‡«ðŸ‡·</span>
                    French
                </div>
                <div class="language-badge">
                    <span class="language-flag">ðŸ‡©ðŸ‡ª</span>
                    German
                </div>
            </div>
        </div>
        
        <button class="open-duolingo" onclick="">
            Open Duolingo
        </button>
        <br>
        <br>
        <button class="quest-button" onclick="">
            Check if Quest Completed
        </button>

    </div>
</body>
<script>
    function applyTheme(theme) {
    const root = document.documentElement;
    const card = document.querySelector('.profile-card');
    const elements = document.querySelectorAll('.theme-transition');
    
    [card, ...elements].forEach(el => {
        if (el) el.classList.add('theme-transition');
    });

    root.style.setProperty('--color-primary', theme.primary || '#00FF9F');
    root.style.setProperty('--color-on-primary', theme.onPrimary || '#000000');
    root.style.setProperty('--color-secondary', theme.secondary || '#00BFFF');
    root.style.setProperty('--color-on-secondary', theme.onSecondary || '#000000');
    root.style.setProperty('--color-tertiary', theme.tertiary || '#8A2BE2');
    root.style.setProperty('--color-on-tertiary', theme.onTertiary || '#FFFFFF');
    root.style.setProperty('--color-background', theme.background || '#0A0A0A');
    root.style.setProperty('--color-on-background', theme.onBackground || '#00FF9F');
    root.style.setProperty('--color-surface', theme.surface || '#111111');
    root.style.setProperty('--color-on-surface', theme.onSurface || '#B0FFDA');
    root.style.setProperty('--color-error', theme.error || '#FF0040');
    root.style.setProperty('--color-on-error', theme.onError || '#000000');

}

async function loadDuolingoProfile(username) {
    const loadingEl = document.querySelector('.loading');
    if (loadingEl) {
        loadingEl.style.display = 'flex';
    }

    const isFreshCheck = document.activeElement?.classList.contains('quest-button');
    const cacheKey = `duolingo_user_${username}_cache`;
    const cached = localStorage.getItem(cacheKey);

    if (!isFreshCheck && cached) {
        const cachedData = JSON.parse(cached);
        const age = Date.now() - cachedData.timestamp;
        if (age < 1000 * 60 * 60) {
            renderProfile(cachedData.user);
            return;
        }
    }

    try {
        WebAppInterface.fetchDataWithoutCorsAsync(
            `https://www.duolingo.com/2017-06-30/users?username=${encodeURIComponent(username)}`,
            '{"Accept": "application/json"}',
            "handleDuolingoResponse"
        );
    } catch (err) {
        console.error(err);
        alert("Failed to load Duolingo profile. Check the username.");
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

function handleDuolingoResponse(responseText) {
    try {
        const data = JSON.parse(responseText);
        if (!data.users || data.users.length === 0) throw new Error("User not found");

        const user = data.users[0];
        const wasButtonClicked = document.activeElement?.classList.contains('quest-button');
        
        // Get current streak from API (prioritize currentStreak, fallback to previousStreak length)
        const apiCurrentStreak = user.streakData?.currentStreak?.length || 
                                 user.streakData?.length || 
                                 user.streak || 0;
        
        const apiPreviousStreak = user.streakData?.previousStreak?.length || 0;

        const apiCurrentStreakDate = user.streakData?.currentStreak?.endDate || null;
        // Check if current streak date is today (YYYY-MM-DD)
        let isCurrentStreakToday = false;
        if (apiCurrentStreakDate) {
            const todayStr = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
            isCurrentStreakToday = apiCurrentStreakDate === todayStr;
        }

        // Get our stored data
        const storageKey = `streak_tracker_${user.username}`;
        let storedData = JSON.parse(localStorage.getItem(storageKey) || 'null');
        
        const today = new Date().toDateString();
        const now = new Date().toISOString();
        
        // First time setup
        if (!storedData) {
            // Check if user already completed today's quest before first check
            const hasCompletedToday = isCurrentStreakToday;
            
            storedData = {
                lastKnownStreak: apiCurrentStreak,
                lastCheckDate: today,
                lastCheckTime: now,
                completedDates: hasCompletedToday ? [today] : []
            };
            localStorage.setItem(storageKey, JSON.stringify(storedData));
            
            if(hasCompletedToday){
                    WebAppInterface.toast("Quest already completed today! ðŸŒŸ");
                    WebAppInterface.onQuestCompleted();
            }
            if (wasButtonClicked) {
                if (hasCompletedToday) {
                    WebAppInterface.toast("Quest already completed today! ðŸŒŸ");
                } else {
                    WebAppInterface.toast("Perform a lesson to complete quest! ðŸŽ¯");
                }
            }
            
            renderProfile(user);
            return;
        }
        
        // Check if this is a new day
        const isNewDay = storedData.lastCheckDate !== today;
        
        if (isNewDay) {
            // New day: reset stored streak to current API streak
            storedData.lastKnownStreak = apiCurrentStreak;
            storedData.lastCheckDate = today;
            storedData.lastCheckTime = now;
            // Keep completed dates for history but we'll only check today
        }

        // If the API reports a smaller streak than we have stored (e.g. user lost streak),
        // sync the local stored streak down so future increases are detected correctly.
        // This covers the case: local shows 69, API dropped to 0 â€” we must set local to 0.
        if (apiCurrentStreak < storedData.lastKnownStreak) {
            // If the streak dropped to zero, it's possible today's completion (if present)
            // is no longer valid â€” remove today's completion marker to avoid false positives.
            const todayIndex = storedData.completedDates?.indexOf(today);
            if (todayIndex >= 0 && apiCurrentStreak === 0) {
                storedData.completedDates.splice(todayIndex, 1);
            }

            storedData.lastKnownStreak = apiCurrentStreak;
            storedData.lastCheckTime = now;
            // Persist the correction immediately so subsequent checks use the corrected value
            localStorage.setItem(storageKey, JSON.stringify(storedData));
        }
        
        // Determine if quest is completed today
        const questCompletedToday = storedData.completedDates.includes(today);
        const streakIncreased = apiCurrentStreak > storedData.lastKnownStreak;
        
        if (wasButtonClicked) {
            if (questCompletedToday) {
                // Already got reward today
                WebAppInterface.toast("You've already completed today's quest! ðŸŒŸ");
            } else if (streakIncreased) {
                // Streak increased since last check - give reward!
                try {
                    WebAppInterface.onQuestCompleted();
                    WebAppInterface.toast(`Quest completed! Streak: ${apiCurrentStreak} days ðŸŽ‰`);
                    
                    // Mark as completed
                    storedData.completedDates.push(today);
                    storedData.lastKnownStreak = apiCurrentStreak;
                    storedData.lastCheckTime = now;
                    localStorage.setItem(storageKey, JSON.stringify(storedData));
                } catch (e) {
                    console.log('Quest completion notification failed:', e);
                }
            } else {
                // Streak hasn't increased yet
                WebAppInterface.toast("Perform a lesson today to complete quest ðŸŽ¯");
            }
        } else {
            // Auto check - just update timestamp
            storedData.lastCheckTime = now;
            localStorage.setItem(storageKey, JSON.stringify(storedData));
        }

        // Cache profile data
        const cacheKey = `duolingo_user_${user.username}_cache`;
        localStorage.setItem(cacheKey, JSON.stringify({ 
            user, 
            timestamp: Date.now() 
        }));

        renderProfile(user);
    } catch (err) {
        console.error(err);
        alert("Failed to load Duolingo profile. Check the username.");
        const loadingEl = document.querySelector('.loading');
        if (loadingEl) loadingEl.style.display = 'none';
    }
}

function renderProfile(user) {
    const avatarEl = document.querySelector('.avatar');
    const usernameEl = document.querySelector('.username');
    const joinDateEl = document.querySelector('.join-date');
    const streakEl = document.querySelector('.stats-grid .streak-highlight .stat-number');
    const xpEl = document.querySelectorAll('.stat-item')[1].querySelector('.stat-number');
    const languagesListEl = document.querySelector('.languages-list');
    const lastUpdatedEl = document.querySelector('.last-updated');
    const streakStatusEl = document.querySelector('.streak-status');

    // Get stored data for display
    const storageKey = `streak_tracker_${user.username}`;
    const storedData = JSON.parse(localStorage.getItem(storageKey) || 'null');
    
    if (storedData && storedData.lastCheckTime) {
        const lastCheck = new Date(storedData.lastCheckTime);
        lastUpdatedEl.textContent = `Last updated: ${lastCheck.toLocaleString()}`;
        
        // Check streak status
        const hoursSinceCheck = (Date.now() - lastCheck.getTime()) / (1000 * 60 * 60);
        const today = new Date().toDateString();
        const completedToday = storedData.completedDates.includes(today);
        
        if (completedToday) {
            streakStatusEl.textContent = "Quest completed today!";
            streakStatusEl.className = "streak-status safe";
        } else if (hoursSinceCheck > 20) {
            streakStatusEl.textContent = "Check in today to maintain your streak!";
            streakStatusEl.className = "streak-status warning";
        } else {
            streakStatusEl.textContent = "Complete a lesson today!";
            streakStatusEl.className = "streak-status pending";
        }
    }

    usernameEl.textContent = user.username;
    const joinDate = new Date(user.creationDate * 1000);
    joinDateEl.textContent = `Joined ${joinDate.toLocaleString('default', { month: 'long', year: 'numeric' })}`;

    const currentStreak = user.streakData?.currentStreak?.length || 
                          user.streakData?.length || 
                          user.streak || 0;
    streakEl.textContent = currentStreak;
    xpEl.textContent = user.totalXp || 0;

    languagesListEl.innerHTML = '';
    (user.courses || []).forEach(course => {
        const langDiv = document.createElement('div');
        langDiv.className = 'language-badge';
        langDiv.innerHTML = `<span class="language-flag">${getFlag(course.learningLanguage)}</span>${course.title}`;
        languagesListEl.appendChild(langDiv);
    });

    document.querySelector('.profile-card').style.display = 'block';
    
    const loadingEl = document.querySelector('.loading');
    if (loadingEl) loadingEl.style.display = 'none';
}

function getFlag(langCode) {
    const flags = {
        'es': 'ðŸ‡ªðŸ‡¸',
        'fr': 'ðŸ‡«ðŸ‡·',
        'de': 'ðŸ‡©ðŸ‡ª',
        'ja': 'ðŸ‡¯ðŸ‡µ',
        'ru': 'ðŸ‡·ðŸ‡º',
        'la': 'ðŸ›ï¸'
    };
    return flags[langCode] || 'ðŸ³ï¸';
}

function injectData(data) {
    try {
        let parsed;

        if (typeof data === "object") {
            parsed = data;
        } 
        else if (typeof data === "string") {
            parsed = JSON.parse(data);
            if (typeof parsed === "string") {
                parsed = JSON.parse(parsed);
            }
        } else {
            throw new Error("Invalid data format");
        }

        const { username } = parsed;
        if (!username) throw new Error("Username is required");

        loadDuolingoProfile(username);

        const questButton = document.querySelector(".quest-button");
        if (questButton) {
            questButton.disabled = false;
            questButton.addEventListener("click", () => loadDuolingoProfile(username));
        }

    } catch (err) {
        console.error("Inject data error:", err);
        WebAppInterface.toast("Failed to load profile: " + err.message);
    }
}

window.onload = function() {
    const questButton = document.querySelector('.quest-button');
    if (questButton) {
        questButton.disabled = true;
    }
    const openDuoButton = document.querySelector(".open-duolingo");
    if (openDuoButton) {
        openDuoButton.disabled = false;
        openDuoButton.addEventListener("click", () => {
            WebAppInterface.openApp("com.duolingo");
        });
    }
};

</script>

</html>